<!DOCTYPE HTML>
<html>
 <head>
  <meta charset="utf-8"/>
  <title>
   Made with Remarkable!
  </title>
  <link href="/usr/share/remarkable/media/highlightjs.default.min.css" rel="stylesheet"/>
  <style type="text/css">
   li,ol,p,ul{line-height:24px}a,button,input,select,textarea{margin:0;vertical-align:baseline}a,button:hover{text-decoration:none}a,ol,ul{padding:0}hr,td,th{text-align:left}body{background:#000;font-family:Georgia,Palatino,serif;color:#EEE;line-height:1;padding:30px;margin:auto;max-width:42em}h1,h2{text-align:center}h1,h2,h3,h4{font-weight:400}h1,h2,h3,h4,h5,p{margin-bottom:24px;padding:0}h1{font-size:48px}h2{font-size:36px;margin:24px 0 6px}h3{font-size:24px}h4{font-size:21px}h5{font-size:18px}a{color:#61BFC1}a:hover{text-decoration:underline}a:visited{color:#466B6C}ol,ul{margin:0}li ul{margin-left:24px}ol,p,ul{font-size:16px;max-width:540px}pre{padding:0 24px;max-width:800px;white-space:pre-wrap}code{font-family:Consolas,Monaco,Andale Mono,monospace;line-height:1.5;font-size:13px}button,input,label,select,textarea{font-family:"Helvetica Neue",Helvetica,Arial,sans-serif}aside{display:block;float:right;width:390px}blockquote{border-left:.5em solid #eee;padding:0 2em;margin-left:0;max-width:476px}blockquote cite{font-size:14px;line-height:20px;color:#bfbfbf}blockquote p{color:#666;max-width:460px}hr{width:540px;margin:0 auto 0 0;color:#999}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}button,input[type=button],input[type=reset],input[type=submit]{cursor:pointer;-webkit-appearance:button}input:not([type=image]),textarea{-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}input[type=search]{-webkit-appearance:textfield;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}input[type=search]::-webkit-search-decoration{-webkit-appearance:none}input,label,select,textarea{font-size:13px;line-height:normal;margin-bottom:18px}input[type=checkbox],input[type=radio]{cursor:pointer;margin-bottom:0}input[type=password],input[type=text],select,textarea{display:inline-block;width:210px;padding:4px;font-size:13px;line-height:18px;height:18px;color:gray;border:1px solid #ccc;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;-webkit-transition:border linear .2s,box-shadow linear .2s;-moz-transition:border linear .2s,box-shadow linear .2s;transition:border linear .2s,box-shadow linear .2s;-webkit-box-shadow:inset 0 1px 3px rgba(0,0,0,.1);-moz-box-shadow:inset 0 1px 3px rgba(0,0,0,.1);box-shadow:inset 0 1px 3px rgba(0,0,0,.1)}input[type=file],select{height:27px;line-height:27px}textarea{height:auto}:-moz-placeholder{color:#bfbfbf}::-webkit-input-placeholder{color:#bfbfbf}input[type=password]:focus,input[type=text]:focus,textarea:focus{outline:0;border-color:rgba(82,168,236,.8);-webkit-box-shadow:inset 0 1px 3px rgba(0,0,0,.1),0 0 8px rgba(82,168,236,.6);-moz-box-shadow:inset 0 1px 3px rgba(0,0,0,.1),0 0 8px rgba(82,168,236,.6);box-shadow:inset 0 1px 3px rgba(0,0,0,.1),0 0 8px rgba(82,168,236,.6)}button{display:inline-block;padding:4px 14px;font-size:13px;line-height:18px;-webkit-border-radius:4px;-moz-border-radius:4px;border-radius:4px;-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);-moz-box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);background-color:#0064cd;background-repeat:repeat-x;background-image:-khtml-gradient(linear,left top,left bottom,from(#049cdb),to(#0064cd));background-image:-moz-linear-gradient(top,#049cdb,#0064cd);background-image:-ms-linear-gradient(top,#049cdb,#0064cd);background-image:-webkit-gradient(linear,left top,left bottom,color-stop(0,#049cdb),color-stop(100%,#0064cd));background-image:-webkit-linear-gradient(top,#049cdb,#0064cd);background-image:-o-linear-gradient(top,#049cdb,#0064cd);background-image:linear-gradient(top,#049cdb,#0064cd);color:#fff;text-shadow:0 -1px 0 rgba(0,0,0,.25);border:1px solid #004b9a;-webkit-transition:.1s linear all;-moz-transition:.1s linear all;transition:.1s linear all;border-color:#0064cd #0064cd #003f81;border-color:rgba(0,0,0,.1) rgba(0,0,0,.1) rgba(0,0,0,.25)}button:hover{color:#fff;background-position:0 -15px}button:active{-webkit-box-shadow:inset 0 3px 7px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.05);-moz-box-shadow:inset 0 3px 7px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.05);box-shadow:inset 0 3px 7px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.05)}button::-moz-focus-inner{padding:0;border:0}mark{background-color:#ff69b4}table{border-collapse:collapse}td,th{border:1px solid #fff;padding:.5rem}.hljs{display:block;overflow-x:auto;padding:.5em;background:#2b2b2b;color:#bababa}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#6896ba}.hljs-code,.hljs-selector-class{color:#a6e22e}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#cb7832}.hljs-params{color:#b9b9b9}.hljs-string{color:#6a8759}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable,.hljs-type{color:#e0c46c}.hljs-comment,.hljs-deletion,.hljs-meta{color:#7f7f7f}
  </style>
 </head>
 <body>
  <p>
   This was a
   <a href="Feb2022.html">
    Feburary
   </a>
   thing
  </p>
  <h2>
   Docking a 3D printer with OctoPrint
  </h2>
  <p>
   I have the
   <strong>
    Creality Ender 3V2 3D printer
   </strong>
   , but I have a small problem. A small
   <strong>
    8ft
   </strong>
   ladder access problem :(
  </p>
  <p>
   The ladder leads to a 5ft square (well ventilated) area with the printer in the middle. I was taking a USB key from my
   <strong>
    Gentoo
   </strong>
   machine and then climbing up the ladder, setting up the printer and then continiously going back up and down to check on the print process.
   <strong>
    REMEMBER
   </strong>
   printers can catch on
   <strong>
    FIRE
   </strong>
   .
  </p>
  <p>
   The solution is obviously
   <a href="https://octoprint.org/">
    OctoPrint
   </a>
   . Remote access to 3D printers with realtime camera view, stats and timelapse videos.
  </p>
  <p>
   But would it work on MY 3D printer?
   <strong>
    TLDR
   </strong>
   ;
   <em>
    yes
   </em>
  </p>
  <h2>
   Skipping the OctoPi for direct Docker
  </h2>
  <p>
   Now I had heard that to host
   <a href="https://octoprint.org/">
    OctoPrint
   </a>
   on the
   <strong>
    Raspberry Pi
   </strong>
   there is a special version called
   <a href="https://github.com/guysoft/OctoPi">
    Octo-pi
   </a>
  </p>
  <p>
   At the same time I wanted to play with
   <a href="https://www.docker.com/">
    Docker
   </a>
  </p>
  <p>
   <a href="https://www.docker.com/">
    Docker
   </a>
   runs things as containers that have no access to anything that you do not explicity give them access too. i.e. Sandboxed.
  </p>
  <p>
   note this container is
   <a href="https://octoprint.org/">
    OctoPrint
   </a>
   not
   <a href="https://github.com/guysoft/OctoPi">
    Octo-pi
   </a>
   - (
   <a href="https://github.com/guysoft/OctoPi">
    Octo-pi
   </a>
   <em>
    now
   </em>
   has a
   <a href="https://github.com/guysoft/CustomPiOS/wiki/Building-with-Docker">
    Docker image info page
   </a>
   )
  </p>
  <h2>
   Pi Prep
  </h2>
  <p>
   I got the
   <strong>
    Pi (Pi Zero W)
   </strong>
   working first and made sure the camera was enabled (
   <strong>
    Raspberry Pi OS
   </strong>
   currently uses
   <strong>
    Buster
   </strong>
   so you have to manually
   <a href="https://www.raspberrypi.com/documentation/accessories/camera.html">
    enable the camera interface in legacy mode
   </a>
   )
  </p>
  <p>
   Usual download: Lite image from
   <a href="https://www.raspberrypi.com/software/operating-systems/">
    raspberrypi.com
   </a>
  </p>
  <ul>
   <li>
    <code class="nohighlight">
     <span class="hljs-built_in">dd</span>
    </code>
    image to SD card
   </li>
   <li>
    setup ssh and Wifi
   </li>
   <li>
    <ul>
     <li>
      (Wifi
      <strong>
       <code class="nohighlight">
        wp<span class="hljs-built_in">a_supplicant</span>.conf
       </code>
      </strong>
      must have
      <strong>
       country code
      </strong>
      set now)
     </li>
    </ul>
   </li>
   <li>
    ssh'd in and enabled the camera with
    <strong>
     raspi-config
    </strong>
   </li>
   <li>
    <p>
     did a sanity check with
     <code class="nohighlight">
<span class="hljs-attribute">      raspistill</span>
     </code>
     to make sure the camera worked
    </p>
    <p>
     raspistill -o /tmp/image.jpg
    </p>
   </li>
  </ul>
  <p>
   All good!
  </p>
  <h2>
   Docker up OctoPrint
  </h2>
  <p>
   Then to install docker I went against all the guides that downloaded it from the
   <strong>
    Docker
   </strong>
   website and instead used the repositories (means I might have got an older version, but I wanted to live dangerously).
  </p>
  <pre><code>sudo usermod --append --groups docker $USER
sudo apt install docker-compose
</code></pre>
  <p>
   (
   <strong>
    <em>
     docker-compose
    </em>
   </strong>
   is not
   <strong>
    Docker
   </strong>
   , but does include the
   <strong>
    docker
   </strong>
   command. It is confusing, but will make sense later)
  </p>
  <p>
   Test that Docker is installed and ready to go
  </p>
  <pre><code>docker --version
Docker version 20.10.5+dfsg1, build 55c4c88

sudo docker run --rm hello-world
</code></pre>
  <p>
   Now I can get the latest octoprint
   <strong>
    docker-compose
   </strong>
   file (remember
   <strong>
    OctoPi
   </strong>
   <em>
    now
   </em>
   has
   <strong>
    Docker
   </strong>
   instructions)
  </p>
  <pre><code class="nohighlight">wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/OctoPrint/</span>octoprint-docker<span class="hljs-regexp">/raw/m</span>aster/docker-compose.yml
</code></pre>
  <p>
   Oh, I need to  know what interface the Pi is using to the printer.
  </p>
  <pre><code class="nohighlight">sudo apt-<span class="hljs-built_in">get</span> install <span class="hljs-keyword">python3</span>-pip
<span class="hljs-keyword">python</span> -<span class="hljs-keyword">m</span> serial.tools.miniterm
</code></pre>
  <p>
   lists
  </p>
  <pre><code class="nohighlight"><span class="hljs-regexp">/dev/</span>ttyAMA0 
<span class="hljs-regexp">/dev/</span>ttyUSB0
</code></pre>
  <p>
   and updated to the
   <code class="nohighlight">
    docker-compose<span class="hljs-selector-class">.yml</span>
   </code>
   file (lots of trial and error to get it just right)
  </p>
  <h3>
   docker-compose.yml tweaks
  </h3>
  <p>
   Ports need to be changed from
  </p>
  <pre><code class="nohighlight"><span class="hljs-attribute">80</span>:<span class="hljs-number">80</span>
</code></pre>
  <p>
   to
  </p>
  <pre><code class="nohighlight"><span class="hljs-attribute">5000</span>:<span class="hljs-number">5000</span>
<span class="hljs-attribute">8080</span>:<span class="hljs-number">8080</span>
</code></pre>
  <p>
   Where
   <strong>
    5000
   </strong>
   is a non-privilaged port. Means I can use a web browser on another machine in the network.
   <strong>
    8080
   </strong>
   is so I can see the
   <strong>
    raw camera stream
   </strong>
   without needing
   <strong>
    OctoPrint
   </strong>
   . Ideal when I can take my phone up the ladder and muck about with the Pi camera alignment.
  </p>
  <p>
   Enabled devices and added the USB port from earlier
  </p>
  <pre><code class="nohighlight">devices:
- <span class="hljs-regexp">/dev/</span>ttyUSB0:<span class="hljs-regexp">/dev/</span>ttyUSB0
- <span class="hljs-regexp">/dev/</span>video0:<span class="hljs-regexp">/dev/</span>video0
</code></pre>
  <p>
   Enabled the environment variable for streaming from the camera
  </p>
  <pre><code class="nohighlight"><span class="hljs-attribute">environment</span>:
<span class="hljs-literal">-</span> ENABLE_MJPG_STREAMER=true
</code></pre>
  <p>
   and just because it was there and I was interested, I enabled the extra
   <strong>
    config-editor
   </strong>
   docker container.
  </p>
  <p>
   This allows you to use a web browser to edit config files. didn't need it, but was interesting to see working.
  </p>
  <h2>
   Make it start on Boot
  </h2>
  <p>
   Now I need to make sure everything works on on
   <strong>
    Power On
   </strong>
   . The power socket is at the
   <em>
    bottom
   </em>
   of the ladder ;)
  </p>
  <pre><code class="nohighlight">sudo systemctl <span class="hljs-built_in">enable</span> docker
sudo systemctl <span class="hljs-built_in">enable</span> docker.service
sudo systemctl <span class="hljs-built_in">enable</span> containerd.service
</code></pre>
  <p>
   Reboot and wait an age, but it is working!
  </p>
  <p>
   Then configure my
   <strong>
    Creality Ender 3V2 3D printer
   </strong>
   in the
   <strong>
    Octoprint
   </strong>
   GUI from a remote machine on port
   <strong>
    5000
   </strong>
   :)
  </p>
  <p>
   <a href="https://howchoo.com/octoprint/ender-3-v2-octoprint">
    https://howchoo.com/octoprint/ender-3-v2-octoprint
   </a>
  </p>
  <h2>
   Some quick Docker trouble shooting steps
  </h2>
  <pre><code class="nohighlight"><span class="hljs-attribute">docker-compose ps</span>
</code></pre>
  <p>
   shows running containers
  </p>
  <pre><code class="nohighlight">sudo ls -Ral <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>containers/
</code></pre>
  <p>
   will find all the files including logs for the containers. They have very long identifiers.
  </p>
  <h1>
   Additional References
  </h1>
  <h3>
   OctoPrint Docker Hub
  </h3>
  <p>
   <a href="https://hub.docker.com/r/octoprint/octoprint">
    https://hub.docker.com/r/octoprint/octoprint
   </a>
  </p>
  <h3>
   Official configuration docs
  </h3>
  <p>
   <a href="https://docs.octoprint.org/en/master/configuration/config_yaml.html#server">
    https://docs.octoprint.org/en/master/configuration/config_yaml.html#server
   </a>
  </p>
  <p>
   Reference list of timezones used in docker
   <a href="https://docs.diladele.com/docker/timezones.html">
    https://docs.diladele.com/docker/timezones.html
   </a>
  </p>
  <h3>
   Other useful links
  </h3>
  <p>
   <a href="https://www.abqlug.com/tutorials/installing-pi-hole-docker-compose-for-dummies/">
    https://www.abqlug.com/tutorials/installing-pi-hole-docker-compose-for-dummies/
   </a>
  </p>
  <p>
   <a href="https://pumpingco.de/blog/setup-your-raspberry-pi-for-docker-and-docker-compose/">
    https://pumpingco.de/blog/setup-your-raspberry-pi-for-docker-and-docker-compose/
   </a>
  </p>
  <p>
   <a href="https://jfrog.com/connect/post/install-docker-compose-on-raspberry-pi/">
    https://jfrog.com/connect/post/install-docker-compose-on-raspberry-pi/
   </a>
  </p>
  <p>
   <a href="https://www.baeldung.com/ops/docker-volumes">
    https://www.baeldung.com/ops/docker-volumes
   </a>
  </p>
  <script src="/usr/share/remarkable/media/highlight.min.js">
  </script>
  <script>
   hljs.initHighlightingOnLoad();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript">
  </script>
  <script type="text/javascript">
   MathJax.Hub.Config({"showProcessingMessages" : false,"messageStyle" : "none","tex2jax": { inlineMath: [ [ "$", "$" ] ] }});
  </script>
 </body>
</html>